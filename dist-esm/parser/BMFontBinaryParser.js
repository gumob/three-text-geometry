import{BMFontLoaderError,BMFontLoaderErrorType}from"../error";import{DefaultBMFont,DefaultBMFontCommon,DefaultBMFontInfo,DefaultBMFontKern}from"../types";class BMFontBinaryParser{parse(t){if(t.length<6)throw new BMFontLoaderError(BMFontLoaderErrorType.ParseError,"Invalid buffer length for BMFont");if(!BMFontBinaryParser.HEADER.every((r,e)=>t.readUInt8(e)===r))throw new BMFontLoaderError(BMFontLoaderErrorType.ParseError,"BMFont missing BMF byte header");let e=3;if(3<t.readUInt8(e++))throw new BMFontLoaderError(BMFontLoaderErrorType.ParseError,"Only supports BMFont Binary v3 (BMFont App v1.10)");var n=DefaultBMFont();for(let r=0;r<5;r++)e+=this.readBlock(n,t,e);return n}readBlock(r,e,t){if(t>e.length-1)return 0;var n=e.readUInt8(t++),a=e.readInt32LE(t);switch(t+=4,n){case 1:r.info=this.readInfo(e,t);break;case 2:r.common=this.readCommon(e,t);break;case 3:r.pages=this.readPages(e,t,a);break;case 4:r.chars=this.readChars(e,t,a);break;case 5:r.kernings=this.readKernings(e,t,a)}return 5+a}readInfo(r,e){const t=DefaultBMFontInfo();t.size=r.readInt16LE(e);var n=r.readUInt8(e+2);return t.smooth=n>>7&1,t.unicode=n>>6&1,t.italic=n>>5&1,t.bold=n>>4&1,n>>3&1&&(t.fixedHeight=1),t.stretchH=r.readUInt16LE(e+4),t.aa=r.readUInt8(e+6),t.padding=[r.readInt8(e+7),r.readInt8(e+8),r.readInt8(e+9),r.readInt8(e+10)],t.spacing=[r.readInt8(e+11),r.readInt8(e+12)],t.outline=r.readUInt8(e+13),t.face=this.readStringNT(r,e+14),t}readCommon(r,e){const t=DefaultBMFontCommon();return t.lineHeight=r.readUInt16LE(e),t.base=r.readUInt16LE(e+2),t.scaleW=r.readUInt16LE(e+4),t.scaleH=r.readUInt16LE(e+6),t.pages=r.readUInt16LE(e+8),t.packed=0,t.alphaChnl=r.readUInt8(e+11),t.redChnl=r.readUInt8(e+12),t.greenChnl=r.readUInt8(e+13),t.blueChnl=r.readUInt8(e+14),t}readPages(e,t,r){const n=[];var a=this.readNameNT(e,t),o=a.length+1,d=r/o;for(let r=0;r<d;r++)n[r]=e.slice(t,t+a.length).toString("utf8"),t+=o;return n}readChars(e,t,r){const n=[];var a=r/20;for(let r=0;r<a;r++){const d={id:0,index:0,char:"",width:0,height:0,xoffset:0,yoffset:0,xadvance:0,chnl:0,x:0,y:0,page:0};var o=20*r;d.id=e.readUInt32LE(t+0+o),d.x=e.readUInt16LE(t+4+o),d.y=e.readUInt16LE(t+6+o),d.width=e.readUInt16LE(t+8+o),d.height=e.readUInt16LE(t+10+o),d.xoffset=e.readInt16LE(t+12+o),d.yoffset=e.readInt16LE(t+14+o),d.xadvance=e.readInt16LE(t+16+o),d.page=e.readUInt8(t+18+o),d.chnl=e.readUInt8(t+19+o),n[r]=d}return n}readKernings(e,t,r){const n=[];var a=r/10;for(let r=0;r<a;r++){const d=DefaultBMFontKern();var o=10*r;d.first=e.readUInt32LE(t+0+o),d.second=e.readUInt32LE(t+4+o),d.amount=e.readInt16LE(t+8+o),n[r]=d}return n}readStringNT(r,e){return this.readNameNT(r,e).toString("utf8")}readNameNT(r,e){let t=e;for(;t<r.length&&0!==r[t];t++);return r.slice(e,t)}}BMFontBinaryParser.HEADER=[66,77,70];export{BMFontBinaryParser};