import{BMFontError}from"../error";import{DefaultBMFont,DefaultBMFontCommon,DefaultBMFontInfo,DefaultBMFontKern}from"../types";class BMFontBinaryParser{parse(t){if(t.length<6)throw new BMFontError("Invalid buffer length");if(!BMFontBinaryParser.HEADER.every((e,r)=>t.readUInt8(r)===e))throw new BMFontError("Missing BMF byte header");let r=3;if(3<t.readUInt8(r++))throw new BMFontError("Only supports bitmap font binary v3");var n=DefaultBMFont();try{for(let e=0;e<5;e++)r+=this.readBlock(n,t,r)}catch(e){throw new BMFontError(e.message)}return n}readBlock(e,r,t){if(t>r.length-1)return 0;var n=r.readUInt8(t++),a=r.readInt32LE(t);switch(t+=4,n){case 1:e.info=this.readInfo(r,t);break;case 2:e.common=this.readCommon(r,t);break;case 3:e.pages=this.readPages(r,t,a);break;case 4:e.chars=this.readChars(r,t,a);break;case 5:e.kernings=this.readKernings(r,t,a)}return 5+a}readInfo(e,r){const t=DefaultBMFontInfo();t.size=e.readInt16LE(r);var n=e.readUInt8(r+2);return t.smooth=n>>7&1,t.unicode=n>>6&1,t.italic=n>>5&1,t.bold=n>>4&1,n>>3&1&&(t.fixedHeight=1),t.stretchH=e.readUInt16LE(r+4),t.aa=e.readUInt8(r+6),t.padding=[e.readInt8(r+7),e.readInt8(r+8),e.readInt8(r+9),e.readInt8(r+10)],t.spacing=[e.readInt8(r+11),e.readInt8(r+12)],t.outline=e.readUInt8(r+13),t.face=this.readStringNT(e,r+14),t}readCommon(e,r){const t=DefaultBMFontCommon();return t.lineHeight=e.readUInt16LE(r),t.base=e.readUInt16LE(r+2),t.scaleW=e.readUInt16LE(r+4),t.scaleH=e.readUInt16LE(r+6),t.pages=e.readUInt16LE(r+8),t.packed=0,t.alphaChnl=e.readUInt8(r+11),t.redChnl=e.readUInt8(r+12),t.greenChnl=e.readUInt8(r+13),t.blueChnl=e.readUInt8(r+14),t}readPages(r,t,e){const n=[];var a=this.readNameNT(r,t),o=a.length+1,d=e/o;for(let e=0;e<d;e++)n[e]=r.slice(t,t+a.length).toString("utf8"),t+=o;return n}readChars(r,t,e){const n=[];var a=e/20;for(let e=0;e<a;e++){const d={id:0,index:0,char:"",width:0,height:0,xoffset:0,yoffset:0,xadvance:0,chnl:0,x:0,y:0,page:0};var o=20*e;d.id=r.readUInt32LE(t+0+o),d.x=r.readUInt16LE(t+4+o),d.y=r.readUInt16LE(t+6+o),d.width=r.readUInt16LE(t+8+o),d.height=r.readUInt16LE(t+10+o),d.xoffset=r.readInt16LE(t+12+o),d.yoffset=r.readInt16LE(t+14+o),d.xadvance=r.readInt16LE(t+16+o),d.page=r.readUInt8(t+18+o),d.chnl=r.readUInt8(t+19+o),n[e]=d}return n}readKernings(r,t,e){const n=[];var a=e/10;for(let e=0;e<a;e++){const d=DefaultBMFontKern();var o=10*e;d.first=r.readUInt32LE(t+0+o),d.second=r.readUInt32LE(t+4+o),d.amount=r.readInt16LE(t+8+o),n[e]=d}return n}readStringNT(e,r){return this.readNameNT(e,r).toString("utf8")}readNameNT(e,r){let t=r;for(;t<e.length&&0!==e[t];t++);return e.slice(r,t)}}BMFontBinaryParser.HEADER=[66,77,70];export{BMFontBinaryParser};